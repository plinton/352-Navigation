<!DOCTYPE html>  <html> <head>   <title>nav.strategy.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="nav.agent.html">                 nav.agent.js               </a>                                           <a class="source" href="nav.core.html">                 nav.core.js               </a>                                           <a class="source" href="nav.obstacle.html">                 nav.obstacle.js               </a>                                           <a class="source" href="nav.strategy.html">                 nav.strategy.js               </a>                                           <a class="source" href="nav.world.html">                 nav.world.js               </a>                                           <a class="source" href="navigation.html">                 navigation.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               nav.strategy.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Strategies will maintain all internal state related to one agent's navigation. 
For example, if an agent is using A* navigation, the A* strategy object keeps
it's planned path. If an agent is using dynamical systems navigation, the 
dynamical systems object keeps track of the agent's world representation.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">Strategy</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Create closures for each strategy to encapsulate things like local
classes that the strategies don't need to share </p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">strategyObj</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Extend the math object to add hyperbolic trigonometric functions </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">Math</span><span class="p">.</span><span class="nx">sinh</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="nx">x</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>  
        <span class="p">};</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">cosh</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="nx">x</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>    
        <span class="p">};</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">tanh</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">){</span>
            <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sinh</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cosh</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
        <span class="p">};</span>


        <span class="kd">function</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">rad</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">center</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="nx">rad</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">collision</span><span class="p">(</span><span class="nx">o1</span><span class="p">,</span> <span class="nx">o2</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">o1</span><span class="p">.</span><span class="nx">health</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
                <span class="nx">o1</span><span class="p">.</span><span class="nx">takeDamage</span><span class="p">();</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">o2</span><span class="p">.</span><span class="nx">health</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">){</span>
                <span class="nx">o2</span><span class="p">.</span><span class="nx">takeDamage</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Dynamical systems navigation strategy object </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">function</span> <span class="nx">Dynamical</span><span class="p">(</span><span class="nx">world</span><span class="p">){</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">world</span> <span class="o">=</span> <span class="nx">world</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">envObs</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Parameters</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">d0</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">c1</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">c2</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sigma</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">h1</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>advantage of going towards target</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">aTar</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>advantage of going to target over obstacle</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">gTarObs</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">timestep</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">;</span>
		<span class="p">}</span>

        
		<span class="nx">Dynamical</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Returns angle between an agent and a target</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">computeAngle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aPos</span><span class="p">,</span> <span class="nx">tPos</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">d</span><span class="o">=</span><span class="nx">aPos</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">tPos</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">d</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">tPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;=</span><span class="nx">aPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)){</span>
                    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">((</span><span class="nx">tPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nx">aPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="nx">d</span><span class="p">)</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">tPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;=</span><span class="nx">aPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)){</span>
                    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">((</span><span class="nx">tPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="nx">aPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="nx">d</span><span class="p">)</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span><span class="p">{</span>
                    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">((</span><span class="nx">aPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="nx">tPos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="nx">d</span><span class="p">)</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Returns delta Psi, the angle between the internal tangents of 
two circles.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">subtendedAngle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">agent</span><span class="p">,</span> <span class="nx">obs</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">aPos</span><span class="o">=</span><span class="nx">agent</span><span class="p">.</span><span class="nx">center</span><span class="p">,</span>
                     <span class="nx">aRad</span><span class="o">=</span><span class="nx">agent</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span>
                     <span class="nx">oPos</span><span class="o">=</span><span class="nx">obs</span><span class="p">.</span><span class="nx">center</span><span class="p">,</span>
                     <span class="nx">oRad</span><span class="o">=</span><span class="nx">obs</span><span class="p">.</span><span class="nx">radius</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">bigRad</span><span class="o">=</span><span class="nx">aRad</span><span class="o">+</span><span class="nx">oRad</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">d</span><span class="o">=</span><span class="nx">aPos</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">oPos</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">bigRad</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">d</span> <span class="o">=</span> <span class="nx">bigRad</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">theta</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(</span><span class="nx">bigRad</span><span class="o">/</span><span class="nx">d</span><span class="p">));</span>
                <span class="k">return</span> <span class="nx">theta</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Calculates attraction of a target.
In Juan Pablo's code, this is fTar</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">calculateAttraction</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psiTar</span><span class="p">);</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Distance function. Adjusts force of repeller by distance.
In Juan Pablo's code, this is D</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">distanceFunc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dm</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="nx">dm</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">d0</span><span class="p">));</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Adjusts need to avoid obstacles</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">alphaObs</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">perceivedObs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;}</span>
                <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">tanh</span><span class="p">(</span><span class="nx">perceivedObs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ob</span><span class="p">){</span>
                                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">distanceFunc</span><span class="p">(</span><span class="nx">ob</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                                <span class="p">},</span><span class="k">this</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">curr</span><span class="p">){</span>
                                    <span class="k">return</span> <span class="nx">prev</span> <span class="o">+</span> <span class="nx">curr</span><span class="p">;</span>
                                <span class="p">}));</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Windowing function. Sees if obstacle is in the way.
In Juan Pablo's code, this is W</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">windowFunc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psi</span><span class="p">,</span> <span class="nx">dPsi</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">phiPsi</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psi</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">dPsiSigma</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">dPsi</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">sigma</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">tan</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">tanh</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">h1</span> <span class="o">*</span> <span class="p">(</span><span class="nx">phiPsi</span> <span class="o">-</span> <span class="nx">dPsiSigma</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="nx">tan</span><span class="p">);</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Repeller function. Gets the repelling power of an obstacle.
In Juan Pablo's code, this is R</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">repellerFunc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psi</span><span class="p">,</span> <span class="nx">dPsi</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">((</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psi</span><span class="p">)</span><span class="o">/</span><span class="nx">dPsi</span><span class="p">)</span> <span class="o">*</span>
                    <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">((</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psi</span><span class="p">)</span><span class="o">/</span><span class="nx">dPsi</span><span class="p">));</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Returns 1 if x > 0, 0 if x == 0 and -1 if x &lt; 0.
In Juan Pablo's code, this is sign.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">signum</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="nx">x</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The complete repeller function.
In Juan Pablo's code, this is fObsI</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">fullRepellerFunc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">obs</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">dist</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">distanceFunc</span><span class="p">(</span><span class="nx">obs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                    <span class="nx">win</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">windowFunc</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">obs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                    <span class="nx">rep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">repellerFunc</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">obs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">obs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                <span class="k">return</span> <span class="nx">dist</span> <span class="o">*</span> <span class="nx">win</span> <span class="o">*</span> <span class="nx">rep</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Detects where the target is.
In Juan Pablo's code, this is P_tar</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">targetDetector</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">dFtar_dPhi</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psiTar</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">signum</span><span class="p">(</span><span class="nx">dFtar_dPhi</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">c1</span> <span class="o">*</span> 
                    <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">calculateAttraction</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">)));</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Detects if an obstacle is in the way.
In Juan Pablo's code, this is P_obs</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">obsDetector</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">obsList</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">fObs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">dFobs_dPhi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">Di</span><span class="p">,</span> <span class="nx">Wi</span><span class="p">,</span> <span class="nx">Ri</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">,</span> <span class="nx">help</span><span class="p">,</span> <span class="nx">dWi</span><span class="p">,</span> <span class="nx">dRi</span><span class="p">,</span> <span class="nx">psi</span><span class="p">,</span> <span class="nx">dm</span><span class="p">,</span> <span class="nx">dPsi</span><span class="p">;</span>
                </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Each obstacle is an array of the form:
  [dm, psi, dPsi]</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">obsList</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ob</span><span class="p">){</span>
                    <span class="nx">dm</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="nx">psi</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                    <span class="nx">dPsi</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                    <span class="nx">Di</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">distanceFunc</span><span class="p">(</span><span class="nx">dm</span><span class="p">);</span>
                    <span class="nx">Wi</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">windowFunc</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psi</span><span class="p">,</span> <span class="nx">dPsi</span><span class="p">);</span>
                    <span class="nx">Ri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">repellerFunc</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psi</span><span class="p">,</span> <span class="nx">dPsi</span><span class="p">);</span>

                    <span class="nx">fObs</span> <span class="o">=</span> <span class="nx">fObs</span> <span class="o">+</span> <span class="p">(</span><span class="nx">Di</span> <span class="o">*</span> <span class="nx">Wi</span> <span class="o">*</span> <span class="nx">Ri</span><span class="p">);</span>
                    <span class="nx">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cosh</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">h1</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psi</span><span class="p">)</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">dPsi</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">sigma</span><span class="p">))));</span>
                    <span class="nx">help</span> <span class="o">=</span> <span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psi</span><span class="p">)</span><span class="o">/</span><span class="nx">dPsi</span><span class="p">;</span>
                    <span class="nx">dWi</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">h1</span> <span class="o">*</span> <span class="nx">tmp</span> <span class="o">*</span> <span class="nx">tmp</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psi</span><span class="p">));</span>
                    <span class="nx">dRi</span> <span class="o">=</span> <span class="p">(((</span><span class="nx">dPsi</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psi</span><span class="p">))</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">help</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="nx">dPsi</span> <span class="o">*</span> <span class="nx">dPsi</span><span class="p">));</span>
                    <span class="nx">dFobs_dPhi</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">Di</span> <span class="o">*</span> <span class="p">(</span><span class="nx">Wi</span> <span class="o">*</span> <span class="nx">dRi</span> <span class="o">+</span> <span class="nx">dWi</span> <span class="o">*</span> <span class="nx">Ri</span><span class="p">));</span>
                    <span class="nx">w</span> <span class="o">+=</span> <span class="nx">Wi</span><span class="p">;</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
                

                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">signum</span><span class="p">(</span><span class="nx">dFobs_dPhi</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">c1</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">fObs</span><span class="p">))</span> <span class="o">*</span> <span class="nx">w</span><span class="p">;</span>
                
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Sees if agent is heading towards a stable point or unstable 
point</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">gammaObsTar</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">pTar</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">targetDetector</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">),</span>
                    <span class="nx">pObs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">obsDetector</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">c2</span> <span class="o">*</span> <span class="nx">pTar</span> <span class="o">*</span> <span class="nx">pObs</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">c2</span><span class="p">);</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Defines an attractor.
In Juan Pablo's code, this is fTar.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">defAttractor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span> <span class="o">-</span> <span class="nx">psiTar</span><span class="p">);</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Gets the weight of a target and a repeller.
returns in the form [weight of targer, weight of obstacle]</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">getWeights</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">,</span> <span class="nx">weightTarget</span><span class="p">,</span> <span class="nx">weightObs</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">a2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">alphaObs</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">),</span>
                    <span class="nx">g21</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gammaObsTar</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>w1 is target, w2 is obstacle</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="kd">var</span> <span class="nx">w1dot</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">aTar</span> <span class="o">*</span> <span class="nx">weightTarget</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">weightTarget</span> <span class="o">*</span>
                        <span class="nx">weightTarget</span><span class="p">)</span> <span class="o">-</span> <span class="nx">g21</span> <span class="o">*</span> <span class="nx">weightObs</span> <span class="o">*</span> <span class="nx">weightObs</span> <span class="o">*</span> 	 	
                        <span class="nx">weightTarget</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">));</span> 	
                    <span class="kd">var</span> <span class="nx">w2dot</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a2</span> <span class="o">*</span> <span class="nx">weightObs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">weightObs</span> <span class="o">*</span> <span class="nx">weightObs</span><span class="p">)</span> <span class="o">-</span> 	
                    <span class="k">this</span><span class="p">.</span><span class="nx">gTarObs</span> <span class="o">*</span> <span class="nx">weightTarget</span> <span class="o">*</span> <span class="nx">weightTarget</span> <span class="o">*</span> 	 	
                        <span class="nx">weightTarget</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">));</span>	 	
                    <span class="nx">weightTarget</span> <span class="o">+=</span> <span class="nx">w1dot</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestep</span><span class="p">;</span> 	
                    <span class="nx">weightObs</span> <span class="o">+=</span> <span class="nx">w2dot</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestep</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">weightTarget</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">weightTarget</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">weightTarget</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">weightObs</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">weightObs</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">weightObs</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="p">[</span><span class="nx">weightTarget</span><span class="p">,</span> <span class="nx">weightObs</span><span class="p">];</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Get the heading that the agent should be moving in</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">getPhiDot</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">agent</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">phi</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">fObs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">psiTar</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">computeAngle</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">paul</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
                <span class="nx">agent</span><span class="p">.</span><span class="nx">weights</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getWeights</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">,</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="nx">agent</span><span class="p">.</span><span class="nx">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">perceivedObs</span><span class="p">);</span> <span class="c1">//of the form [wtar, wobs]</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">perceivedObs</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">fObs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="nx">fObs</span> <span class="o">=</span> <span class="nx">perceivedObs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                        <span class="kd">var</span> <span class="nx">frf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">fullRepellerFunc</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">elem</span><span class="p">);</span>
						<span class="k">return</span> <span class="nx">frf</span><span class="p">;</span>
					<span class="p">},</span> <span class="k">this</span><span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">prev</span><span class="p">,</span> <span class="nx">curr</span><span class="p">){</span>
						<span class="k">return</span> <span class="nx">prev</span> <span class="o">+</span> <span class="nx">curr</span><span class="p">;</span>
					<span class="p">});</span>
				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>fObs is always negative, so weightedObs is always negative, which is why it turns left all the time</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nx">weightedObs</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="nx">fObs</span><span class="p">);</span> 
				<span class="nx">phiDot</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">defAttractor</span><span class="p">(</span><span class="nx">phi</span><span class="p">,</span> <span class="nx">psiTar</span><span class="p">))</span> <span class="o">+</span> 
                    <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">weightedObs</span> <span class="o">+</span> <span class="mf">0.01</span><span class="o">*</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">phiDot</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Perceive objects</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">sense</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">agent</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span>
                    <span class="nx">agSize</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span>
                    <span class="nx">tarCircle</span> <span class="o">=</span> <span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">)</span> <span class="o">?</span> 
                                    <span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="o">:</span>
                                    <span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span>
                    <span class="nx">perceivedObs</span> <span class="o">=</span> <span class="p">[],</span>
                    <span class="nx">dm</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="nx">psi</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="nx">dPsi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">envObs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">elem</span> <span class="o">!==</span> <span class="nx">agent</span><span class="p">){</span>
                        <span class="nx">dm</span> <span class="o">=</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">center</span><span class="p">)</span> <span class="o">-</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">radius</span> <span class="o">-</span> <span class="nx">agSize</span><span class="p">;</span>
                        <span class="nx">psi</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">computeAngle</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">center</span><span class="p">);</span>
                        <span class="nx">dPsi</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">subtendedAngle</span><span class="p">(</span><span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">pos</span><span class="p">,</span> <span class="nx">agSize</span><span class="p">),</span> <span class="nx">elem</span><span class="p">);</span>
                        <span class="nx">psi</span> <span class="o">=</span> <span class="nx">psi</span><span class="p">;</span>
                        <span class="nx">dPsi</span> <span class="o">=</span> <span class="nx">dPsi</span><span class="p">;</span>
                        <span class="nx">perceivedObs</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">dm</span><span class="p">,</span> <span class="nx">psi</span><span class="p">,</span> <span class="nx">dPsi</span><span class="p">]);</span> 
                    <span class="p">}</span>
                <span class="p">},</span><span class="k">this</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">perceivedObs</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>update the perception of objects</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">updateRepresentation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">agent</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">envObs</span> <span class="o">=</span> <span class="p">[];</span>

                <span class="kd">var</span> <span class="nx">obsCirc</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">elem</span> <span class="o">!==</span> <span class="nx">agent</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">obsCirc</span><span class="o">=</span><span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
                        <span class="nx">obsCirc2</span><span class="o">=</span><span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>collision detection</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">dm</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">obsCirc</span><span class="p">.</span><span class="nx">center</span><span class="p">)</span> <span class="o">-</span> <span class="nx">obsCirc</span><span class="p">.</span><span class="nx">radius</span> <span class="o">-</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">dm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
                            <span class="nx">collision</span><span class="p">(</span><span class="nx">agent</span><span class="p">,</span> <span class="nx">elem</span><span class="p">);</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">computeAngle</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">obsCirc</span><span class="p">.</span><span class="nx">center</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">envObs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obsCirc</span><span class="p">);</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">envObs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obsCirc2</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">obstacles</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    <span class="k">switch</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">case</span> <span class="s2">&quot;block&quot;</span><span class="o">:</span>
                            <span class="nx">obsCirc</span><span class="o">=</span><span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="k">case</span> <span class="s2">&quot;fire&quot;</span><span class="o">:</span>
                            <span class="nx">obsCirc</span><span class="o">=</span><span class="k">new</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">dm</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">obsCirc</span><span class="p">.</span><span class="nx">center</span><span class="p">)</span> <span class="o">-</span> <span class="nx">obsCirc</span><span class="p">.</span><span class="nx">radius</span> <span class="o">-</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">dm</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
                        <span class="nx">collision</span><span class="p">(</span><span class="nx">agent</span><span class="p">,</span> <span class="nx">elem</span><span class="p">);</span>
                        <span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">computeAngle</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span><span class="nx">obsCirc</span><span class="p">.</span><span class="nx">center</span><span class="p">);</span>
                        <span class="k">while</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span><span class="o">&gt;</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">){</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">}</span>
                        <span class="k">while</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span><span class="o">&lt;-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">){</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">envObs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obsCirc</span><span class="p">);</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Execute dynamical systems and move forward one timestep</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">agent</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Currently updates both the position and heading because the position 
is dependent on the old heading</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">updateRepresentation</span><span class="p">(</span><span class="nx">agent</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">perceivedObs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sense</span><span class="p">(</span><span class="nx">agent</span><span class="p">),</span>
                        <span class="nx">pd</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPhiDot</span><span class="p">(</span><span class="nx">agent</span><span class="p">,</span> <span class="nx">perceivedObs</span><span class="p">),</span>
                        <span class="nx">vel</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">velocity</span><span class="p">,</span>
                        <span class="nx">oldHeading</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span><span class="p">,</span>
                        <span class="nx">xd</span> <span class="o">=</span> <span class="nx">vel</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">health</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span><span class="p">),</span>
                        <span class="nx">yd</span> <span class="o">=</span> <span class="nx">vel</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">health</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span><span class="p">);</span>
                    <span class="kd">var</span> <span class="nx">newX</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestep</span> <span class="o">*</span> <span class="nx">xd</span><span class="p">,</span>
                        <span class="nx">newY</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestep</span> <span class="o">*</span> <span class="nx">yd</span><span class="p">,</span>
                        <span class="nx">newHeading</span> <span class="o">=</span> <span class="nx">oldHeading</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestep</span> <span class="o">*</span> <span class="nx">pd</span><span class="p">;</span>
                    <span class="nx">agent</span><span class="p">.</span><span class="nx">heading</span> <span class="o">=</span> <span class="nx">newHeading</span><span class="p">;</span>
                    <span class="nx">agent</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">$V</span><span class="p">([</span><span class="nx">newX</span><span class="p">,</span> <span class="nx">newY</span><span class="p">]);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">size</span><span class="o">+</span><span class="mi">5</span><span class="p">)){</span>
                        <span class="nx">agent</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="nx">agent</span><span class="p">.</span><span class="nx">escaped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
			<span class="p">}</span>
		<span class="p">};</span>
		<span class="nx">Strategy</span><span class="p">.</span><span class="nx">Dynamical</span> <span class="o">=</span> <span class="nx">Dynamical</span><span class="p">;</span>
	<span class="p">})(</span><span class="nx">Strategy</span><span class="p">);</span>



	<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">strategyObj</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Helper function for creating a 2-D Array (Grid)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">Grid</span><span class="p">(</span><span class="nx">rows</span><span class="p">,</span> <span class="nx">cols</span><span class="p">){</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">rows</span><span class="p">;</span> <span class="o">++</span><span class="nx">x</span><span class="p">){</span>
                <span class="k">this</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">cols</span><span class="p">;</span> <span class="o">++</span><span class="nx">y</span><span class="p">){</span>
                    <span class="k">this</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>The 2-Dimensional grid representing the world's occupancy data. A 0 is stored
at position (i, j) if there is no obstacle at cell (i, j) and a 1 otherwise. </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">WorldGrid</span><span class="p">(</span><span class="nx">cellSize</span><span class="p">,</span> <span class="nx">xMax</span><span class="p">,</span> <span class="nx">yMax</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">xMax</span> <span class="o">=</span> <span class="nx">xMax</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">cellSize</span> <span class="o">=</span> <span class="nx">cellSize</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">yMax</span> <span class="o">=</span> <span class="nx">yMax</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">nRows</span> <span class="o">=</span> <span class="nx">yMax</span> <span class="o">/</span> <span class="nx">cellSize</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">nCols</span> <span class="o">=</span> <span class="nx">xMax</span> <span class="o">/</span> <span class="nx">cellSize</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Grid</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nCols</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">nRows</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">WorldGrid</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Add an object at position pos.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">addObject</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">gridSpace</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>

                <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">gridSpace</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">gridSpace</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>This function deals with objects overlapping grid boundaries</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">addObstacle</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obs</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">gridSpacePos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">gridSpacePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">gridSpacePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">switch</span><span class="p">(</span><span class="nx">obs</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span>
                    <span class="k">case</span> <span class="s1">&#39;block&#39;</span><span class="o">:</span>
                        <span class="kd">var</span> <span class="nx">eastEdgeExtent</span><span class="p">,</span> <span class="nx">westEdgeExtent</span><span class="p">,</span> <span class="nx">northEdgeExtent</span><span class="p">,</span> <span class="nx">southEdgeExtent</span><span class="p">;</span>
                        </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Check if the east edge of this block is in another grid square.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">eastEdgeExtent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]));</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">eastEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">gridSpacePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                           <span class="k">this</span><span class="p">.</span><span class="nx">isInWorld</span><span class="p">(</span><span class="nx">eastEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">eastEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">))){</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">eastEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">eastEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    
                        <span class="p">}</span>
                        </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Check if the west edge of this block is in another grid square.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">westEdgeExtent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]));</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">westEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">gridSpacePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                           <span class="k">this</span><span class="p">.</span><span class="nx">isInWorld</span><span class="p">(</span><span class="nx">westEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">westEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">))){</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">westEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">westEdgeExtent</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       
                        <span class="p">}</span>
                        
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;exterior&#39;</span><span class="o">:</span>
                        <span class="k">switch</span><span class="p">(</span><span class="nx">obs</span><span class="p">.</span><span class="nx">direction</span><span class="p">){</span>
                            <span class="k">case</span> <span class="s1">&#39;n&#39;</span><span class="o">:</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">spreadFill</span><span class="p">(</span><span class="nx">obs</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s1">&#39;s&#39;</span><span class="o">:</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">spreadFill</span><span class="p">(</span><span class="nx">obs</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s1">&#39;e&#39;</span><span class="o">:</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">spreadFill</span><span class="p">(</span><span class="nx">obs</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">case</span> <span class="s1">&#39;w&#39;</span><span class="o">:</span>
                                <span class="k">this</span><span class="p">.</span><span class="nx">spreadFill</span><span class="p">(</span><span class="nx">obs</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="k">default</span><span class="o">:</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s1">&#39;fire&#39;</span><span class="o">:</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Approximate a circle on the grid by using the circumscribing square.</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="kd">var</span> <span class="nx">topLeft</span> <span class="o">=</span> <span class="nx">$V</span><span class="p">([</span><span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">size</span><span class="p">]),</span>
                            <span class="nx">bottomRight</span> <span class="o">=</span> <span class="nx">$V</span><span class="p">([</span><span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">obs</span><span class="p">.</span><span class="nx">size</span><span class="p">]),</span>
                            <span class="nx">gridSpace</span><span class="p">;</span>
                            
                            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">topLeft</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bottomRight</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nx">i</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">){</span>
                                <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">topLeft</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">bottomRight</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nx">j</span><span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">){</span>
                                    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isInWorldWS</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">j</span><span class="p">)){</span>
                                        <span class="nx">gridSpace</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">]));</span>    
                                        <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">gridSpace</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">gridSpace</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Fills in a strip of space on the occupancy grid, given an exterior wall object.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">spreadFill</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ob</span><span class="p">,</span> <span class="nx">orientation</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">center</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span>
                    <span class="nx">len</span> <span class="o">=</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">size</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span>
                    <span class="nx">gridCenter</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">ob</span><span class="p">.</span><span class="nx">position</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">orientation</span> <span class="o">===</span> <span class="s1">&#39;h&#39;</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The number of grid squares to the left &amp; right this object extends from its
center.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="kd">var</span> <span class="nx">gridLeftX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)])).</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                        <span class="nx">gridRightX</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">len</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)])).</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                    
                    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">gridRightX</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">){</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">for</span><span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">gridLeftX</span><span class="p">;</span> <span class="nx">x</span><span class="o">--</span><span class="p">){</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">x</span><span class="p">][</span><span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   
                    <span class="p">}</span>

                <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">orientation</span> <span class="o">===</span> <span class="s1">&#39;v&#39;</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>The number of grid squares to the top and bottom this object extends from its
center.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="kd">var</span> <span class="nx">gridTopY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nx">len</span><span class="o">/</span><span class="mi">2</span><span class="p">])).</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                        <span class="nx">gridBottomY</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">center</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">len</span><span class="o">/</span><span class="mi">2</span><span class="p">])).</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                    
                    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">gridBottomY</span><span class="p">;</span> <span class="nx">y</span><span class="o">++</span><span class="p">){</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    
                    <span class="p">}</span>
                    <span class="k">for</span><span class="p">(</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">gridTopY</span><span class="p">;</span> <span class="nx">y</span><span class="o">--</span><span class="p">){</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">gridCenter</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Grid</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nCols</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nRows</span><span class="p">);</span>    
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Remove an object at position pos.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">removeObject</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">nRows</span> <span class="o">*</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">yMax</span><span class="p">))),</span>
                    <span class="nx">col</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">nCols</span> <span class="o">*</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">xMax</span><span class="p">)));</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Takes a row and a column and returns true if the cell at that position
is on the world grid and false otherwise.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">isInWorld</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">col</span><span class="p">,</span> <span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">row</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">row</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">nRows</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">col</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">col</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">nCols</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">isInWorldWS</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">xMax</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">yMax</span><span class="p">);</span>
            <span class="p">},</span>
            </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Takes a row and column and returns an array of valid (row,col) pairs
if they are on the world grid.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">adjacentCells</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">col</span><span class="p">,</span> <span class="nx">row</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>A cell and it's neighbors:</p>

<hr />

<ul>
<li>0|1|2 *</li>
<li>3|4|5 *</li>
<li>6|7|8 *</li>
</ul>

<hr />             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[[</span><span class="nx">col</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">row</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// 0</span>
                               <span class="p">[</span><span class="nx">col</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// 6</span>
                               <span class="p">[</span><span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">row</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// 2</span>
                               <span class="p">[</span><span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// 8</span>
                               <span class="p">[</span><span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">row</span><span class="p">],</span> <span class="c1">// 5</span>
                               <span class="p">[</span><span class="nx">col</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">row</span><span class="p">],</span> <span class="c1">// 3</span>
                               <span class="p">[</span><span class="nx">col</span><span class="p">,</span> <span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// 7</span>
                               <span class="p">[</span><span class="nx">col</span><span class="p">,</span> <span class="nx">row</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span> <span class="c1">// 1</span>
                <span class="kd">var</span> <span class="kr">final</span> <span class="o">=</span>  <span class="nx">results</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isInWorld</span><span class="p">(</span><span class="nx">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nx">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> 
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
                <span class="k">return</span> <span class="kr">final</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Gets the adjacent cells that are open.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">adjacentOpenCells</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">col</span><span class="p">,</span><span class="nx">row</span><span class="p">){</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">adjacentCells</span><span class="p">(</span><span class="nx">col</span><span class="p">,</span><span class="nx">row</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nx">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Converts a vector from grid space to world space. By the nature of this transformation, some information is lost so we
translate to the center of a grid square in world space.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">toWorldSpace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">cellSize</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xMax</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">nCols</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="p">[(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">cellSize</span><span class="p">)</span> <span class="o">+</span> <span class="nx">cellSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nx">cellSize</span><span class="p">)</span> <span class="o">+</span> <span class="nx">cellSize</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>  
            <span class="p">},</span>
            <span class="nx">pairToWorld</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">col</span><span class="p">,</span> <span class="nx">row</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="p">[(</span><span class="nx">col</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">cellSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="nx">row</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">cellSize</span><span class="p">)</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">cellSize</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">toGridSpace</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pos</span><span class="p">){</span>
                <span class="k">return</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(((</span><span class="k">this</span><span class="p">.</span><span class="nx">nCols</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">xMax</span><span class="p">))),</span>
                                       <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(((</span><span class="k">this</span><span class="p">.</span><span class="nx">nRows</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">pos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">yMax</span><span class="p">)))]</span> <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>A node in the search tree. Stores heuristic data as well as parent info.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">function</span> <span class="nx">Node</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nx">Node</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nx">expand</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">successors</span> <span class="o">=</span> <span class="p">[],</span>
				    <span class="nx">results</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">applyOperators</span><span class="p">(),</span>
				    <span class="nx">len</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
				    <span class="nx">i</span><span class="p">;</span>
				<span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">successors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Node</span><span class="p">(</span><span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="k">this</span><span class="p">));</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="nx">successors</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>States in the world represented by a 2d Grid.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">function</span> <span class="nx">GridNavState</span><span class="p">(</span><span class="nx">col</span><span class="p">,</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">grid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">col</span> <span class="o">=</span> <span class="nx">col</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">row</span> <span class="o">=</span> <span class="nx">row</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">grid</span> <span class="o">=</span> <span class="nx">grid</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="nx">GridNavState</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Returns an array of states if they represent cells that are are adjacent to the current
cell and not obstructed. </p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">applyOperators</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Generate the possible moves and create states from them.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">adjacentOpenCells</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">col</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">row</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
					<span class="k">return</span> <span class="k">new</span> <span class="nx">GridNavState</span><span class="p">(</span><span class="nx">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nx">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">);</span>
				<span class="p">},</span> <span class="k">this</span><span class="p">);</span>
				<span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
			<span class="p">},</span>
			<span class="nx">equals</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">otherState</span><span class="p">){</span>
				<span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">col</span> <span class="o">===</span> <span class="nx">otherState</span><span class="p">.</span><span class="nx">col</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">row</span> <span class="o">===</span> <span class="nx">otherState</span><span class="p">.</span><span class="nx">row</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Perform heuristic search.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">function</span> <span class="nx">heuristicSearch</span><span class="p">(</span><span class="nx">initialState</span><span class="p">,</span> <span class="nx">goalState</span><span class="p">,</span> <span class="nx">fringe</span><span class="p">,</span> <span class="nx">heuristic</span><span class="p">){</span>
			<span class="kd">var</span> <span class="nx">maxExpansions</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
			    <span class="nx">nodesExpanded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nx">start</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Node</span><span class="p">(</span><span class="nx">initialState</span><span class="p">),</span>
				<span class="nx">closedStates</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HashSet</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">u</span><span class="p">){</span><span class="k">return</span> <span class="nx">$V</span><span class="p">([</span><span class="nx">u</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span> <span class="nx">u</span><span class="p">.</span><span class="nx">col</span><span class="p">]);},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span><span class="nx">v</span><span class="p">){</span><span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">v</span><span class="p">);}),</span>
			    <span class="nx">current</span><span class="p">,</span>
			    <span class="nx">new_nodes</span><span class="p">;</span>
			<span class="nx">fringe</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>

			<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="nx">fringe</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()){</span>
				<span class="nx">current</span> <span class="o">=</span> <span class="nx">fringe</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">goalState</span><span class="p">)){</span>
					<span class="k">return</span> <span class="nx">current</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">closedStates</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">state</span><span class="p">)){</span>
					<span class="nx">closedStates</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">state</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="nx">nodesExpanded</span> <span class="o">&lt;</span> <span class="nx">maxExpansions</span><span class="p">){</span>
						<span class="nx">new_nodes</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">expand</span><span class="p">();</span>
						<span class="nx">nodesExpanded</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">new_nodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
						<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">new_nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
							<span class="nx">new_nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
							<span class="nx">new_nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">heuristic</span><span class="p">(</span><span class="nx">new_nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">state</span><span class="p">,</span> <span class="nx">goalState</span><span class="p">);</span>
							<span class="nx">fringe</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">new_nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Euclidean distance heuristic for A*</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">function</span> <span class="nx">straightLineDist</span><span class="p">(</span><span class="nx">currState</span><span class="p">,</span> <span class="nx">goalState</span><span class="p">){</span>
            <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">currState</span><span class="p">.</span><span class="nx">row</span> <span class="o">-</span> <span class="nx">goalState</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">currState</span><span class="p">.</span><span class="nx">col</span> <span class="o">-</span> <span class="nx">goalState</span><span class="p">.</span><span class="nx">col</span><span class="p">,</span><span class="mi">2</span><span class="p">)));</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>A* navigation strategy object </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">function</span> <span class="nx">AStar</span><span class="p">(</span><span class="nx">world</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">world</span> <span class="o">=</span> <span class="nx">world</span><span class="p">;</span>
            </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Create the world grid here</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">grid</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WorldGrid</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">800</span><span class="p">,</span><span class="mi">600</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">updateRepresentation</span><span class="p">();</span>
            </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Map from agent ids to path arrays.
Needed so we can verify the validity of paths against the /grid/, 
which agents themselves have nor should have access to. Now when an agent
calls execute, the A* module will first check if that agent's path is valid
then if it is, return the node the agent should be heading to currently. If not
it will recompute the path and store it here.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="p">}</span>
		<span class="nx">AStar</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Convert from a node chain to an actual path.
Input: A node that is the final node in a search path.
Output: An array of vectors representing the path in grid space.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">toPath</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">agent</span><span class="p">){</span>

                <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[</span><span class="nx">$V</span><span class="p">([</span><span class="nx">node</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">col</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">row</span><span class="p">])];</span>
                <span class="k">while</span><span class="p">((</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parent</span><span class="p">)){</span>
                    <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">$V</span><span class="p">([</span><span class="nx">node</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">col</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">row</span><span class="p">]));</span>
                <span class="p">}</span>
                <span class="nx">results</span> <span class="o">=</span>  <span class="nx">results</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">toWorldSpace</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
                <span class="nx">results</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Generate the navigation path for the agent to follow</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">plan</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
				
			<span class="p">},</span>
            <span class="nx">updateRepresentation</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
                
                <span class="k">this</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">addObject</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">position</span><span class="p">);</span>
                <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">obstacles</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">){</span>
                    
                    <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">addObstacle</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
                <span class="p">},</span><span class="k">this</span><span class="p">);</span>
                
                
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Check if a given path is invalid.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">pathInvalid</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">agent</span><span class="p">){</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">path</span><span class="p">){</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>    
                <span class="p">}</span>
 </pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>We only care about obstructions along the first maxDistance nodes of the path
since looking only so far ahead means there's a higher chance a further obstruction
will be the fault of a dynamic object, so it will have moved away by the time we reach
it.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="kd">var</span> <span class="nx">maxDistance</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="nx">agentCell</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">),</span>
                    <span class="nx">node</span><span class="p">;</span>
                    
                <span class="nx">maxDistance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">maxDistance</span> <span class="o">?</span> <span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">maxDistance</span><span class="p">);</span>
                <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">maxDistance</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
                    <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">path</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">)][</span><span class="nx">node</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
                       <span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="nx">agentCell</span><span class="p">)){</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>    
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Returns the next intermediate target an agent needs to reach its goal.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">getNextTarget</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">agent</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">gridPos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">),</span>
                    <span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span><span class="p">[</span><span class="nx">agent</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">path</span><span class="p">,</span>
                    <span class="nx">currentTarget</span> <span class="o">=</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span><span class="p">){</span>
                    <span class="kd">var</span> <span class="nx">currentTargetGrid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">currentTarget</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">distanceFrom</span><span class="p">(</span><span class="nx">currentTarget</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">){</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">escaped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span><span class="p">[</span><span class="nx">agent</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
                            <span class="k">while</span><span class="p">(</span><span class="nx">gridPos</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span><span class="p">)){</span>
                                <span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>   
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span> <span class="o">=</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
                <span class="p">}</span>
            <span class="p">},</span>
			<span class="nx">execute</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">agent</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">updateRepresentation</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">){</span>
                    <span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span><span class="p">[</span><span class="nx">agent</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
                        <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">pathInvalid</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span><span class="p">[</span><span class="nx">agent</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">path</span><span class="p">,</span> <span class="nx">agent</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span><span class="p">[</span><span class="nx">agent</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">goal</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">)){</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">getNextTarget</span><span class="p">(</span><span class="nx">agent</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">shouldReplan</span><span class="p">){</span>
            			<span class="kd">var</span> <span class="nx">gridSpacePos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">position</span><span class="p">),</span>
            			    <span class="nx">gridSpaceTar</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">toGridSpace</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span><span class="p">),</span>
            			    <span class="nx">initial</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GridNavState</span><span class="p">(</span><span class="nx">gridSpacePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">gridSpacePos</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">),</span>
            			    <span class="nx">goal</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GridNavState</span><span class="p">(</span><span class="nx">gridSpaceTar</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nx">gridSpaceTar</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">grid</span><span class="p">),</span>
            			    <span class="nx">fringe</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BinHeap</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">){</span> <span class="k">return</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">h</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">g</span><span class="p">);</span> <span class="p">}),</span>
            			    <span class="nx">heuristic</span> <span class="o">=</span> <span class="nx">straightLineDist</span><span class="p">,</span>
            			    <span class="nx">result</span> <span class="o">=</span> <span class="nx">heuristicSearch</span><span class="p">(</span><span class="nx">initial</span><span class="p">,</span> <span class="nx">goal</span><span class="p">,</span> <span class="nx">fringe</span><span class="p">,</span> <span class="nx">heuristic</span><span class="p">);</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">result</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">){</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span><span class="p">[</span><span class="nx">agent</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                                       <span class="nx">path</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">toPath</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">agent</span><span class="p">),</span>
                                                       <span class="nx">goal</span><span class="o">:</span><span class="nx">agent</span><span class="p">.</span><span class="nx">target</span>
                                                      <span class="p">};</span>
            			    <span class="nx">agent</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pathHash</span><span class="p">[</span><span class="nx">agent</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">path</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">interTarget</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                            <span class="nx">agent</span><span class="p">.</span><span class="nx">failedLastPlan</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>    
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
			<span class="p">}</span>
		<span class="p">};</span>
		<span class="nx">Strategy</span><span class="p">.</span><span class="nx">AStar</span> <span class="o">=</span> <span class="nx">AStar</span><span class="p">;</span>
	<span class="p">})(</span><span class="nx">Strategy</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Expose the two navigation strategies under
Nav.strategy.<nav_strat></p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">Nav</span><span class="p">.</span><span class="nx">Strategy</span> <span class="o">=</span> <span class="nx">Strategy</span><span class="p">;</span>
<span class="p">})();</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 